name: Signup With LDAP
authgear.yaml:
  override: |
    authentication:
      identities:
        - ldap
        - login_id
    identity:
      ldap:
        servers:
          - name: ldap-server-1
            url: ldap://localhost:8389
            base_dn: dc=example,dc=org
            search_filter_template: "(uid={{`{{.Username}}`}})"
            user_id_attribute_name: uid
steps:
  - action: create
    input: |
      {
        "type": "signup",
        "name": "default"
      }
    output:
      result: |
        {
          "action": {
            "type": "identify",
            "data" {
              "options"  [
                "[[arrayof]]",
                {
                  "identification": "ldap",
                  "server_name": "ldap-server-1"
                }
              ]
            }
          }
        }
  - action: input
    input: |
      {
        "identification": "ldap",
        "server_name": "ldap-server-1",
        "username": "jdoe",
        "password": "jdoepassword"
      }
    output:
      result: |
        {
          "action": {
            "type": "finished"
          }
        }
---
name: Signup With LDAP - Invalid credentail - Wrong password
authgear.yaml:
  override: |
    authentication:
      identities:
        - ldap
        - login_id
    identity:
      ldap:
        servers:
          - name: ldap-server-1
            url: ldap://localhost:8389
            base_dn: dc=example,dc=org
            search_filter_template: "(uid={{`{{.Username}}`}})"
            user_id_attribute_name: uid
steps:
  - action: create
    input: |
      {
        "type": "signup",
        "name": "default"
      }
    output:
      result: |
        {
          "action": {
            "type": "identify",
            "data" {
              "options"  [
                "[[arrayof]]",
                {
                  "identification": "ldap",
                  "server_name": "ldap-server-1"
                }
              ]
            }
          }
        }
  - action: input
    input: |
      {
        "identification": "ldap",
        "server_name": "ldap-server-1",
        "username": "jdoe",
        "password": "jdoepassword-wrong"
      }
    output:
      result: |
        {
          "error": {
            "name": "Unauthorized",
            "reason": "InvalidCredentials",
            "code": 401
          }
        }
---
name: Signup With LDAP - Invalid credentail - Not such user
authgear.yaml:
  override: |
    authentication:
      identities:
        - ldap
        - login_id
    identity:
      ldap:
        servers:
          - name: ldap-server-1
            url: ldap://localhost:8389
            base_dn: dc=example,dc=org
            search_filter_template: "(uid={{`{{.Username}}`}})"
            user_id_attribute_name: uid
steps:
  - action: create
    input: |
      {
        "type": "signup",
        "name": "default"
      }
    output:
      result: |
        {
          "action": {
            "type": "identify",
            "data" {
              "options"  [
                "[[arrayof]]",
                {
                  "identification": "ldap",
                  "server_name": "ldap-server-1"
                }
              ]
            }
          }
        }
  - action: input
    input: |
      {
        "identification": "ldap",
        "server_name": "ldap-server-1",
        "username": "not-such-user",
        "password": "password"
      }
    output:
      result: |
        {
          "error": {
            "name": "Unauthorized",
            "reason": "InvalidCredentials",
            "code": 401
          }
        }
