// Code generated by Wire. DO NOT EDIT.

//go:generate wire
//+build !wireinject

package auth

import (
	"github.com/authgear/authgear-server/pkg/auth/handler/oauth"
	webapp2 "github.com/authgear/authgear-server/pkg/auth/handler/webapp"
	"github.com/authgear/authgear-server/pkg/auth/handler/webapp/viewmodels"
	"github.com/authgear/authgear-server/pkg/auth/webapp"
	"github.com/authgear/authgear-server/pkg/lib/audit"
	"github.com/authgear/authgear-server/pkg/lib/authn/authenticator/oob"
	"github.com/authgear/authgear-server/pkg/lib/authn/authenticator/password"
	service2 "github.com/authgear/authgear-server/pkg/lib/authn/authenticator/service"
	"github.com/authgear/authgear-server/pkg/lib/authn/authenticator/totp"
	"github.com/authgear/authgear-server/pkg/lib/authn/challenge"
	"github.com/authgear/authgear-server/pkg/lib/authn/identity/anonymous"
	"github.com/authgear/authgear-server/pkg/lib/authn/identity/biometric"
	"github.com/authgear/authgear-server/pkg/lib/authn/identity/loginid"
	oauth3 "github.com/authgear/authgear-server/pkg/lib/authn/identity/oauth"
	"github.com/authgear/authgear-server/pkg/lib/authn/identity/service"
	"github.com/authgear/authgear-server/pkg/lib/authn/mfa"
	"github.com/authgear/authgear-server/pkg/lib/authn/otp"
	"github.com/authgear/authgear-server/pkg/lib/authn/sso"
	"github.com/authgear/authgear-server/pkg/lib/authn/user"
	"github.com/authgear/authgear-server/pkg/lib/config"
	"github.com/authgear/authgear-server/pkg/lib/deps"
	"github.com/authgear/authgear-server/pkg/lib/elasticsearch"
	"github.com/authgear/authgear-server/pkg/lib/event"
	"github.com/authgear/authgear-server/pkg/lib/facade"
	"github.com/authgear/authgear-server/pkg/lib/feature/forgotpassword"
	"github.com/authgear/authgear-server/pkg/lib/feature/verification"
	"github.com/authgear/authgear-server/pkg/lib/feature/welcomemessage"
	"github.com/authgear/authgear-server/pkg/lib/hook"
	"github.com/authgear/authgear-server/pkg/lib/infra/db/appdb"
	"github.com/authgear/authgear-server/pkg/lib/infra/db/auditdb"
	"github.com/authgear/authgear-server/pkg/lib/infra/middleware"
	"github.com/authgear/authgear-server/pkg/lib/interaction"
	"github.com/authgear/authgear-server/pkg/lib/nonce"
	oauth2 "github.com/authgear/authgear-server/pkg/lib/oauth"
	"github.com/authgear/authgear-server/pkg/lib/oauth/handler"
	"github.com/authgear/authgear-server/pkg/lib/oauth/oidc"
	handler2 "github.com/authgear/authgear-server/pkg/lib/oauth/oidc/handler"
	"github.com/authgear/authgear-server/pkg/lib/oauth/pq"
	"github.com/authgear/authgear-server/pkg/lib/oauth/redis"
	"github.com/authgear/authgear-server/pkg/lib/ratelimit"
	"github.com/authgear/authgear-server/pkg/lib/session"
	"github.com/authgear/authgear-server/pkg/lib/session/access"
	"github.com/authgear/authgear-server/pkg/lib/session/idpsession"
	"github.com/authgear/authgear-server/pkg/lib/translation"
	"github.com/authgear/authgear-server/pkg/lib/web"
	"github.com/authgear/authgear-server/pkg/util/clock"
	"github.com/authgear/authgear-server/pkg/util/httproute"
	"github.com/authgear/authgear-server/pkg/util/httputil"
	"github.com/authgear/authgear-server/pkg/util/rand"
	"github.com/authgear/authgear-server/pkg/util/template"
	"net/http"
)

// Injectors from wire_handler.go:

func newOAuthAuthorizeHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	authorizeHandlerLogger := oauth.NewAuthorizeHandlerLogger(factory)
	handle := appProvider.AppDatabase
	request := p.Request
	context := deps.ProvideRequestContext(request)
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	oAuthConfig := appConfig.OAuth
	httpConfig := appConfig.HTTP
	authorizationHandlerLogger := handler.NewAuthorizationHandlerLogger(factory)
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	redisHandle := appProvider.Redis
	logger := redis.NewLogger(factory)
	clock := _wireSystemClockValue
	store := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      logger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clock,
	}
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	urlProvider := &oauth2.URLProvider{
		Endpoints: endpointsProvider,
	}
	serviceLogger := webapp.NewServiceLogger(factory)
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	interactionLogger := interaction.NewLogger(factory)
	identityConfig := appConfig.Identity
	serviceStore := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          serviceStore,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	store2 := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clock,
	}
	service3 := &service2.Service{
		Store:       store2,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	sessionManager := &oauth2.SessionManager{
		Store:  store,
		Clock:  clock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	webappURLProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              webappURLProvider,
		Clock:                    clock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clock,
		URLs:           webappURLProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       webappURLProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	rand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clock,
		Random:       rand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  interactionLogger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	authenticateURLProvider := &webapp.AuthenticateURLProvider{
		Endpoints:     endpointsProvider,
		Pages:         webappService2,
		SessionCookie: cookieDef2,
		CookieFactory: cookieFactory,
		Clock:         clock,
	}
	scopesValidator := _wireScopesValidatorValue
	tokenGenerator := _wireTokenGeneratorValue
	loginHintResolver := &handler.LoginHintResolver{
		Config:           oAuthConfig,
		Anonymous:        anonymousProvider,
		OfflineGrants:    store,
		AppSessionTokens: store,
		AppSessions:      store,
		Clock:            clock,
	}
	authorizationHandler := &handler.AuthorizationHandler{
		Context:         context,
		AppID:           appID,
		Config:          oAuthConfig,
		HTTPConfig:      httpConfig,
		Logger:          authorizationHandlerLogger,
		Authorizations:  authorizationStore,
		CodeGrants:      store,
		OAuthURLs:       urlProvider,
		WebAppURLs:      authenticateURLProvider,
		ValidateScopes:  scopesValidator,
		CodeGenerator:   tokenGenerator,
		LoginHintParser: loginHintResolver,
		Clock:           clock,
	}
	authorizeHandler := &oauth.AuthorizeHandler{
		Logger:       authorizeHandlerLogger,
		Database:     handle,
		AuthzHandler: authorizationHandler,
	}
	return authorizeHandler
}

var (
	_wireSystemClockValue     = clock.NewSystemClock()
	_wireRandValue            = idpsession.Rand(rand.SecureRand)
	_wireScopesValidatorValue = handler.ScopesValidator(oidc.ValidateScopes)
	_wireTokenGeneratorValue  = handler.TokenGenerator(oauth2.GenerateToken)
)

func newOAuthTokenHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	tokenHandlerLogger := oauth.NewTokenHandlerLogger(factory)
	handle := appProvider.AppDatabase
	request := p.Request
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	oAuthConfig := appConfig.OAuth
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	handlerTokenHandlerLogger := handler.NewTokenHandlerLogger(factory)
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	redisHandle := appProvider.Redis
	logger := redis.NewLogger(factory)
	clockClock := _wireSystemClockValue
	store := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      logger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	storeRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	idpsessionRand := _wireRandValue
	provider := &idpsession.Provider{
		Request:      request,
		Store:        storeRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionLogger := interaction.NewLogger(factory)
	authenticationConfig := appConfig.Authentication
	identityConfig := appConfig.Identity
	serviceStore := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	loginidProvider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          serviceStore,
		LoginID:        loginidProvider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	store2 := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oobStoreRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: oobStoreRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       store2,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	httpConfig := appConfig.HTTP
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	cookieDef := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         storeRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef,
	}
	sessionManager := &oauth2.SessionManager{
		Store:  store,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	mfaCookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 provider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef,
		MFADeviceTokenCookie:     mfaCookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  interactionLogger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	oAuthKeyMaterials := deps.ProvideOAuthKeyMaterials(secretConfig)
	idTokenIssuer := &oidc.IDTokenIssuer{
		IDPSessions:   provider,
		OfflineGrants: store,
		Secrets:       oAuthKeyMaterials,
		BaseURL:       endpointsProvider,
		Users:         queries,
		Clock:         clockClock,
	}
	accessTokenEncoding := &oauth2.AccessTokenEncoding{
		Secrets:    oAuthKeyMaterials,
		Clock:      clockClock,
		UserClaims: idTokenIssuer,
		BaseURL:    endpointsProvider,
	}
	tokenGenerator := _wireTokenGeneratorValue
	tokenHandler := &handler.TokenHandler{
		Request:           request,
		AppID:             appID,
		Config:            oAuthConfig,
		TrustProxy:        trustProxy,
		Logger:            handlerTokenHandlerLogger,
		Authorizations:    authorizationStore,
		CodeGrants:        store,
		OfflineGrants:     store,
		AccessGrants:      store,
		AppSessionTokens:  store,
		AccessEvents:      eventProvider,
		Sessions:          provider,
		Graphs:            interactionService,
		IDTokenIssuer:     idTokenIssuer,
		AccessTokenIssuer: accessTokenEncoding,
		GenerateToken:     tokenGenerator,
		Clock:             clockClock,
		Users:             queries,
	}
	oauthTokenHandler := &oauth.TokenHandler{
		Logger:       tokenHandlerLogger,
		Database:     handle,
		TokenHandler: tokenHandler,
	}
	return oauthTokenHandler
}

func newOAuthRevokeHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	revokeHandlerLogger := oauth.NewRevokeHandlerLogger(factory)
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	logger := redis.NewLogger(factory)
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	request := p.Request
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	store := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      logger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	revokeHandler := &handler.RevokeHandler{
		OfflineGrants: store,
		AccessGrants:  store,
	}
	oauthRevokeHandler := &oauth.RevokeHandler{
		Logger:        revokeHandlerLogger,
		Database:      handle,
		RevokeHandler: revokeHandler,
	}
	return oauthRevokeHandler
}

func newOAuthMetadataHandler(p *deps.RequestProvider) http.Handler {
	request := p.Request
	appProvider := p.AppProvider
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	metadataProvider := &oauth2.MetadataProvider{
		Endpoints: endpointsProvider,
	}
	oidcMetadataProvider := &oidc.MetadataProvider{
		Endpoints: endpointsProvider,
	}
	v := ProvideOAuthMetadataProviders(metadataProvider, oidcMetadataProvider)
	metadataHandler := &oauth.MetadataHandler{
		Providers: v,
	}
	return metadataHandler
}

func newOAuthJWKSHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	jwksHandlerLogger := oauth.NewJWKSHandlerLogger(factory)
	request := p.Request
	handle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	clockClock := _wireSystemClockValue
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	storeRedis := &idpsession.StoreRedis{
		Redis:  handle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: handle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	sessionConfig := appConfig.Session
	idpsessionRand := _wireRandValue
	provider := &idpsession.Provider{
		Request:      request,
		Store:        storeRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	logger := redis.NewLogger(factory)
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	context := deps.ProvideRequestContext(request)
	appdbHandle := appProvider.AppDatabase
	sqlExecutor := appdb.NewSQLExecutor(context, appdbHandle)
	store := &redis.Store{
		Redis:       handle,
		AppID:       appID,
		Logger:      logger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthKeyMaterials := deps.ProvideOAuthKeyMaterials(secretConfig)
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticationConfig := appConfig.Authentication
	identityConfig := appConfig.Identity
	serviceStore := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	loginidProvider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          serviceStore,
		LoginID:        loginidProvider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	store2 := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oobStoreRedis := &oob.StoreRedis{
		Redis: handle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: oobStoreRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: handle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       store2,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: handle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: handle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	httpConfig := appConfig.HTTP
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	cookieDef := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         storeRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  store,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	idTokenIssuer := &oidc.IDTokenIssuer{
		IDPSessions:   provider,
		OfflineGrants: store,
		Secrets:       oAuthKeyMaterials,
		BaseURL:       endpointsProvider,
		Users:         queries,
		Clock:         clockClock,
	}
	jwksHandler := &oauth.JWKSHandler{
		Logger: jwksHandlerLogger,
		JWKS:   idTokenIssuer,
	}
	return jwksHandler
}

func newOAuthUserInfoHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	userInfoHandlerLogger := oauth.NewUserInfoHandlerLogger(factory)
	handle := appProvider.AppDatabase
	request := p.Request
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	clockClock := _wireSystemClockValue
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	storeRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	sessionConfig := appConfig.Session
	idpsessionRand := _wireRandValue
	provider := &idpsession.Provider{
		Request:      request,
		Store:        storeRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	logger := redis.NewLogger(factory)
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	store := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      logger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthKeyMaterials := deps.ProvideOAuthKeyMaterials(secretConfig)
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticationConfig := appConfig.Authentication
	identityConfig := appConfig.Identity
	serviceStore := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	loginidProvider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          serviceStore,
		LoginID:        loginidProvider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	store2 := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oobStoreRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: oobStoreRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       store2,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	httpConfig := appConfig.HTTP
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	cookieDef := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         storeRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  store,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	idTokenIssuer := &oidc.IDTokenIssuer{
		IDPSessions:   provider,
		OfflineGrants: store,
		Secrets:       oAuthKeyMaterials,
		BaseURL:       endpointsProvider,
		Users:         queries,
		Clock:         clockClock,
	}
	userInfoHandler := &oauth.UserInfoHandler{
		Logger:           userInfoHandlerLogger,
		Database:         handle,
		UserInfoProvider: idTokenIssuer,
	}
	return userInfoHandler
}

func newOAuthEndSessionHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	endSessionHandlerLogger := oauth.NewEndSessionHandlerLogger(factory)
	handle := appProvider.AppDatabase
	config := appProvider.Config
	appConfig := config.AppConfig
	oAuthConfig := appConfig.OAuth
	request := p.Request
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	appID := appConfig.ID
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	store := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticationConfig := appConfig.Authentication
	identityConfig := appConfig.Identity
	serviceStore := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	clockClock := _wireSystemClockValue
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          serviceStore,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	store2 := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	logger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          logger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	redisHandle := appProvider.Redis
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       store2,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	httpConfig := appConfig.HTTP
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  store,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	cookieDef := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	queries := &user.Queries{
		Store:        store,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	manager2 := &session.Manager{
		Users:               queries,
		IDPSessions:         idpsessionManager,
		AccessTokenSessions: sessionManager,
	}
	endSessionHandler := &handler2.EndSessionHandler{
		Config:         oAuthConfig,
		Endpoints:      endpointsProvider,
		URLs:           urlProvider,
		SessionManager: manager2,
		SessionCookie:  cookieDef,
	}
	oauthEndSessionHandler := &oauth.EndSessionHandler{
		Logger:            endSessionHandlerLogger,
		Database:          handle,
		EndSessionHandler: endSessionHandler,
	}
	return oauthEndSessionHandler
}

func newOAuthChallengeHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	clockClock := _wireSystemClockValue
	provider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	factory := appProvider.LoggerFactory
	jsonResponseWriterLogger := httputil.NewJSONResponseWriterLogger(factory)
	jsonResponseWriter := &httputil.JSONResponseWriter{
		Logger: jsonResponseWriterLogger,
	}
	challengeHandler := &oauth.ChallengeHandler{
		Database:   handle,
		Challenges: provider,
		JSON:       jsonResponseWriter,
	}
	return challengeHandler
}

func newOAuthAppSessionTokenHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	handle := appProvider.AppDatabase
	factory := appProvider.LoggerFactory
	jsonResponseWriterLogger := httputil.NewJSONResponseWriterLogger(factory)
	jsonResponseWriter := &httputil.JSONResponseWriter{
		Logger: jsonResponseWriterLogger,
	}
	request := p.Request
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	oAuthConfig := appConfig.OAuth
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	tokenHandlerLogger := handler.NewTokenHandlerLogger(factory)
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	redisHandle := appProvider.Redis
	logger := redis.NewLogger(factory)
	clockClock := _wireSystemClockValue
	store := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      logger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	storeRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	idpsessionRand := _wireRandValue
	provider := &idpsession.Provider{
		Request:      request,
		Store:        storeRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionLogger := interaction.NewLogger(factory)
	authenticationConfig := appConfig.Authentication
	identityConfig := appConfig.Identity
	serviceStore := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	loginidProvider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          serviceStore,
		LoginID:        loginidProvider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	store2 := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oobStoreRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: oobStoreRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       store2,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	httpConfig := appConfig.HTTP
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	cookieDef := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         storeRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef,
	}
	sessionManager := &oauth2.SessionManager{
		Store:  store,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	mfaCookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 provider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef,
		MFADeviceTokenCookie:     mfaCookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  interactionLogger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	oAuthKeyMaterials := deps.ProvideOAuthKeyMaterials(secretConfig)
	idTokenIssuer := &oidc.IDTokenIssuer{
		IDPSessions:   provider,
		OfflineGrants: store,
		Secrets:       oAuthKeyMaterials,
		BaseURL:       endpointsProvider,
		Users:         queries,
		Clock:         clockClock,
	}
	accessTokenEncoding := &oauth2.AccessTokenEncoding{
		Secrets:    oAuthKeyMaterials,
		Clock:      clockClock,
		UserClaims: idTokenIssuer,
		BaseURL:    endpointsProvider,
	}
	tokenGenerator := _wireTokenGeneratorValue
	tokenHandler := &handler.TokenHandler{
		Request:           request,
		AppID:             appID,
		Config:            oAuthConfig,
		TrustProxy:        trustProxy,
		Logger:            tokenHandlerLogger,
		Authorizations:    authorizationStore,
		CodeGrants:        store,
		OfflineGrants:     store,
		AccessGrants:      store,
		AppSessionTokens:  store,
		AccessEvents:      eventProvider,
		Sessions:          provider,
		Graphs:            interactionService,
		IDTokenIssuer:     idTokenIssuer,
		AccessTokenIssuer: accessTokenEncoding,
		GenerateToken:     tokenGenerator,
		Clock:             clockClock,
		Users:             queries,
	}
	appSessionTokenHandler := &oauth.AppSessionTokenHandler{
		Database:         handle,
		JSON:             jsonResponseWriter,
		AppSessionTokens: tokenHandler,
	}
	return appSessionTokenHandler
}

func newWebAppRootHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	config := appProvider.Config
	appConfig := config.AppConfig
	authenticationConfig := appConfig.Authentication
	httpConfig := appConfig.HTTP
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	rootHandler := &webapp2.RootHandler{
		AuthenticationConfig: authenticationConfig,
		SignedUpCookie:       signedUpCookieDef,
	}
	return rootHandler
}

func newWebAppLoginHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	formPrefiller := &webapp2.FormPrefiller{
		LoginID: loginIDConfig,
		UI:      uiConfig,
	}
	loginHandler := &webapp2.LoginHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		FormPrefiller:     formPrefiller,
		Renderer:          responseRenderer,
	}
	return loginHandler
}

func newWebAppSignupHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	formPrefiller := &webapp2.FormPrefiller{
		LoginID: loginIDConfig,
		UI:      uiConfig,
	}
	signupHandler := &webapp2.SignupHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		FormPrefiller:     formPrefiller,
		Renderer:          responseRenderer,
	}
	return signupHandler
}

func newWebAppPromoteHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	formPrefiller := &webapp2.FormPrefiller{
		LoginID: loginIDConfig,
		UI:      uiConfig,
	}
	promoteHandler := &webapp2.PromoteHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		FormPrefiller:     formPrefiller,
		Renderer:          responseRenderer,
	}
	return promoteHandler
}

func newWebAppSSOCallbackHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	ssoCallbackHandler := &webapp2.SSOCallbackHandler{
		ControllerFactory: controllerFactory,
	}
	return ssoCallbackHandler
}

func newWechatAuthHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	wechatAuthHandler := &webapp2.WechatAuthHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
		IdentityConfig:    identityConfig,
	}
	return wechatAuthHandler
}

func newWechatCallbackHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	jsonResponseWriterLogger := httputil.NewJSONResponseWriterLogger(factory)
	jsonResponseWriter := &httputil.JSONResponseWriter{
		Logger: jsonResponseWriterLogger,
	}
	wechatCallbackHandler := &webapp2.WechatCallbackHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		JSON:              jsonResponseWriter,
	}
	return wechatCallbackHandler
}

func newWebAppEnterLoginIDHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	enterLoginIDHandler := &webapp2.EnterLoginIDHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
		Identities:        serviceService,
	}
	return enterLoginIDHandler
}

func newWebAppEnterPasswordHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	enterPasswordHandler := &webapp2.EnterPasswordHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
	}
	return enterPasswordHandler
}

func newWebAppCreatePasswordHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	createPasswordHandler := &webapp2.CreatePasswordHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
		PasswordPolicy:    passwordChecker,
	}
	return createPasswordHandler
}

func newWebAppSetupTOTPHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	setupTOTPHandler := &webapp2.SetupTOTPHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
		Clock:             clockClock,
		Endpoints:         endpointsProvider,
	}
	return setupTOTPHandler
}

func newWebAppEnterTOTPHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	enterTOTPHandler := &webapp2.EnterTOTPHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
	}
	return enterTOTPHandler
}

func newWebAppSetupOOBOTPHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	setupOOBOTPHandler := &webapp2.SetupOOBOTPHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
	}
	return setupOOBOTPHandler
}

func newWebAppEnterOOBOTPHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	enterOOBOTPHandler := &webapp2.EnterOOBOTPHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
		RateLimiter:       limiter,
		FlashMessage:      flashMessage,
	}
	return enterOOBOTPHandler
}

func newWebAppEnterRecoveryCodeHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	enterRecoveryCodeHandler := &webapp2.EnterRecoveryCodeHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
	}
	return enterRecoveryCodeHandler
}

func newWebAppSetupRecoveryCodeHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	setupRecoveryCodeHandler := &webapp2.SetupRecoveryCodeHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
	}
	return setupRecoveryCodeHandler
}

func newWebAppVerifyIdentityHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	verifyIdentityHandler := &webapp2.VerifyIdentityHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
		Verifications:     verificationService,
		RateLimiter:       limiter,
		FlashMessage:      flashMessage,
	}
	return verifyIdentityHandler
}

func newWebAppVerifyIdentitySuccessHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	verifyIdentitySuccessHandler := &webapp2.VerifyIdentitySuccessHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
	}
	return verifyIdentitySuccessHandler
}

func newWebAppForgotPasswordHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	formPrefiller := &webapp2.FormPrefiller{
		LoginID: loginIDConfig,
		UI:      uiConfig,
	}
	forgotPasswordHandler := &webapp2.ForgotPasswordHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		FormPrefiller:     formPrefiller,
		Renderer:          responseRenderer,
	}
	return forgotPasswordHandler
}

func newWebAppForgotPasswordSuccessHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	forgotPasswordSuccessHandler := &webapp2.ForgotPasswordSuccessHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
	}
	return forgotPasswordSuccessHandler
}

func newWebAppResetPasswordHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	resetPasswordHandler := &webapp2.ResetPasswordHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
		PasswordPolicy:    passwordChecker,
	}
	return resetPasswordHandler
}

func newWebAppResetPasswordSuccessHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	resetPasswordSuccessHandler := &webapp2.ResetPasswordSuccessHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
	}
	return resetPasswordSuccessHandler
}

func newWebAppSettingsHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	biometricConfig := identityConfig.Biometric
	settingsViewModeler := &viewmodels.SettingsViewModeler{
		Authenticators: service3,
		Identities:     serviceService,
		MFA:            mfaService,
		Authentication: authenticationConfig,
		Biometric:      biometricConfig,
	}
	manager2 := &session.Manager{
		Users:               queries,
		IDPSessions:         idpsessionManager,
		AccessTokenSessions: sessionManager,
	}
	settingsHandler := &webapp2.SettingsHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		SettingsViewModel: settingsViewModeler,
		Renderer:          responseRenderer,
		Identities:        serviceService,
		Verification:      verificationService,
		TrustProxy:        trustProxy,
		SessionManager:    manager2,
	}
	return settingsHandler
}

func newWebAppSettingsIdentityHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	settingsIdentityHandler := &webapp2.SettingsIdentityHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
		Identities:        serviceService,
		Verification:      verificationService,
	}
	return settingsIdentityHandler
}

func newWebAppSettingsBiometricHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	settingsBiometricHandler := &webapp2.SettingsBiometricHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
		Identities:        serviceService,
	}
	return settingsBiometricHandler
}

func newWebAppSettingsMFAHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	biometricConfig := identityConfig.Biometric
	settingsViewModeler := &viewmodels.SettingsViewModeler{
		Authenticators: service3,
		Identities:     serviceService,
		MFA:            mfaService,
		Authentication: authenticationConfig,
		Biometric:      biometricConfig,
	}
	settingsMFAHandler := &webapp2.SettingsMFAHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		SettingsViewModel: settingsViewModeler,
		Renderer:          responseRenderer,
		MFA:               mfaService,
	}
	return settingsMFAHandler
}

func newWebAppSettingsTOTPHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	settingsTOTPHandler := &webapp2.SettingsTOTPHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
		Authenticators:    service3,
	}
	return settingsTOTPHandler
}

func newWebAppSettingsOOBOTPHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	settingsOOBOTPHandler := &webapp2.SettingsOOBOTPHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
		Authenticators:    service3,
	}
	return settingsOOBOTPHandler
}

func newWebAppSettingsRecoveryCodeHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	settingsRecoveryCodeHandler := &webapp2.SettingsRecoveryCodeHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
		Authentication:    authenticationConfig,
		MFA:               mfaService,
	}
	return settingsRecoveryCodeHandler
}

func newWebAppSettingsSessionsHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	manager2 := &session.Manager{
		Users:               queries,
		IDPSessions:         idpsessionManager,
		AccessTokenSessions: sessionManager,
	}
	settingsSessionsHandler := &webapp2.SettingsSessionsHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
		Sessions:          manager2,
	}
	return settingsSessionsHandler
}

func newWebAppChangePasswordHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	changePasswordHandler := &webapp2.ChangePasswordHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
		PasswordPolicy:    passwordChecker,
	}
	return changePasswordHandler
}

func newWebAppChangeSecondaryPasswordHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	changeSecondaryPasswordHandler := &webapp2.ChangeSecondaryPasswordHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
		PasswordPolicy:    passwordChecker,
	}
	return changeSecondaryPasswordHandler
}

func newWebAppUserDisabledHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	userDisabledHandler := &webapp2.UserDisabledHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
	}
	return userDisabledHandler
}

func newWebAppLogoutHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	handle := appProvider.AppDatabase
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	config := appProvider.Config
	appConfig := config.AppConfig
	oAuthConfig := appConfig.OAuth
	uiConfig := appConfig.UI
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	appID := appConfig.ID
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	request := p.Request
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	store := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticationConfig := appConfig.Authentication
	identityConfig := appConfig.Identity
	serviceStore := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	clockClock := _wireSystemClockValue
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          serviceStore,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	store2 := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	factory := appProvider.LoggerFactory
	logger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          logger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	redisHandle := appProvider.Redis
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       store2,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	httpConfig := appConfig.HTTP
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  store,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	cookieDef := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	queries := &user.Queries{
		Store:        store,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	manager2 := &session.Manager{
		Users:               queries,
		IDPSessions:         idpsessionManager,
		AccessTokenSessions: sessionManager,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	logoutHandler := &webapp2.LogoutHandler{
		Database:       handle,
		TrustProxy:     trustProxy,
		OAuth:          oAuthConfig,
		UIConfig:       uiConfig,
		SessionManager: manager2,
		BaseViewModel:  baseViewModeler,
		Renderer:       responseRenderer,
	}
	return logoutHandler
}

func newWebAppStaticAssetsHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	manager := appProvider.Resources
	staticAssetsHandler := &webapp2.StaticAssetsHandler{
		Resources: manager,
	}
	return staticAssetsHandler
}

func newWebAppReturnHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	returnHandler := &webapp2.ReturnHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
	}
	return returnHandler
}

func newWebAppErrorHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	handle := appProvider.AppDatabase
	redisHandle := appProvider.Redis
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	serviceLogger := webapp.NewServiceLogger(factory)
	request := p.Request
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	signedUpCookieDef := webapp.NewSignedUpCookieDef(httpConfig)
	authenticationConfig := appConfig.Authentication
	cookieDef := mfa.NewDeviceTokenCookieDef(httpConfig, authenticationConfig)
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	logger := interaction.NewLogger(factory)
	context := deps.ProvideRequestContext(request)
	sqlExecutor := appdb.NewSQLExecutor(context, handle)
	clockClock := _wireSystemClockValue
	identityConfig := appConfig.Identity
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	store := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	provider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          store,
		LoginID:        provider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	serviceStore := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedis := &oob.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: storeRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: redisHandle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       serviceStore,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	idpsessionStoreRedis := &idpsession.StoreRedis{
		Redis:  redisHandle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	sessionConfig := appConfig.Session
	cookieDef2 := session.NewSessionCookieDef(httpConfig, sessionConfig)
	idpsessionManager := &idpsession.Manager{
		Store:         idpsessionStoreRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef2,
	}
	redisLogger := redis.NewLogger(factory)
	redisStore := &redis.Store{
		Redis:       redisHandle,
		AppID:       appID,
		Logger:      redisLogger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthConfig := appConfig.OAuth
	sessionManager := &oauth2.SessionManager{
		Store:  redisStore,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	authenticatorFacade := facade.AuthenticatorFacade{
		Coordinator: coordinator,
	}
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	messageSender := &otp.MessageSender{
		Translation: translationService,
		Endpoints:   endpointsProvider,
		RateLimiter: limiter,
		TaskQueue:   queue,
	}
	codeSender := &oob.CodeSender{
		OTPMessageSender: messageSender,
	}
	oAuthClientCredentials := deps.ProvideOAuthClientCredentials(secretConfig)
	urlProvider := &webapp.URLProvider{
		Endpoints: endpointsProvider,
	}
	wechatURLProvider := &webapp.WechatURLProvider{
		Endpoints: endpointsProvider,
	}
	oAuthProviderFactory := &sso.OAuthProviderFactory{
		Endpoints:                endpointsProvider,
		IdentityConfig:           identityConfig,
		Credentials:              oAuthClientCredentials,
		RedirectURL:              urlProvider,
		Clock:                    clockClock,
		LoginIDNormalizerFactory: normalizerFactory,
		WechatURLProvider:        wechatURLProvider,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	forgotpasswordStore := &forgotpassword.Store{
		AppID: appID,
		Redis: redisHandle,
	}
	providerLogger := forgotpassword.NewProviderLogger(factory)
	forgotpasswordProvider := &forgotpassword.Provider{
		Request:        request,
		Translation:    translationService,
		Config:         forgotPasswordConfig,
		TrustProxy:     trustProxy,
		Store:          forgotpasswordStore,
		Clock:          clockClock,
		URLs:           urlProvider,
		TaskQueue:      queue,
		Logger:         providerLogger,
		Identities:     identityFacade,
		Authenticators: authenticatorFacade,
		RateLimiter:    limiter,
	}
	verificationCodeSender := &verification.CodeSender{
		OTPMessageSender: messageSender,
		WebAppURLs:       urlProvider,
	}
	responseWriter := p.ResponseWriter
	nonceService := &nonce.Service{
		CookieFactory:  cookieFactory,
		Request:        request,
		ResponseWriter: responseWriter,
	}
	elasticsearchCredentials := deps.ProvideElasticsearchCredentials(secretConfig)
	client := elasticsearch.NewClient(elasticsearchCredentials)
	elasticsearchService := &elasticsearch.Service{
		AppID:     appID,
		Client:    client,
		Users:     userStore,
		OAuth:     oauthStore,
		LoginID:   loginidStore,
		TaskQueue: queue,
	}
	challengeProvider := &challenge.Provider{
		Redis: redisHandle,
		AppID: appID,
		Clock: clockClock,
	}
	eventLogger := event.NewLogger(factory)
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	rawProvider := &user.RawProvider{
		RawCommands: rawCommands,
		Queries:     queries,
	}
	storeImpl := &event.StoreImpl{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	hookLogger := hook.NewLogger(factory)
	hookConfig := appConfig.Hook
	webhookKeyMaterials := deps.ProvideWebhookKeyMaterials(secretConfig)
	syncHTTPClient := hook.NewSyncHTTPClient(hookConfig)
	asyncHTTPClient := hook.NewAsyncHTTPClient()
	deliverer := &hook.Deliverer{
		Config:    hookConfig,
		Secret:    webhookKeyMaterials,
		Clock:     clockClock,
		SyncHTTP:  syncHTTPClient,
		AsyncHTTP: asyncHTTPClient,
	}
	sink := &hook.Sink{
		Logger:    hookLogger,
		Deliverer: deliverer,
	}
	auditLogger := audit.NewLogger(factory)
	auditdbHandle := appProvider.AuditDatabase
	auditDatabaseCredentials := deps.ProvideAuditDatabaseCredentials(secretConfig)
	auditdbSQLBuilder := auditdb.NewSQLBuilder(auditDatabaseCredentials, appID)
	auditdbSQLExecutor := auditdb.NewSQLExecutor(context, auditdbHandle)
	auditStore := &audit.Store{
		SQLBuilder:  auditdbSQLBuilder,
		SQLExecutor: auditdbSQLExecutor,
	}
	auditSink := &audit.Sink{
		Logger:   auditLogger,
		Database: auditdbHandle,
		Store:    auditStore,
	}
	eventService := event.NewService(context, request, trustProxy, eventLogger, handle, clockClock, rawProvider, localizationConfig, storeImpl, sink, auditSink)
	commands := &user.Commands{
		Raw:          rawCommands,
		Events:       eventService,
		Verification: verificationService,
	}
	userProvider := &user.Provider{
		Commands: commands,
		Queries:  queries,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	idpsessionProvider := &idpsession.Provider{
		Request:      request,
		Store:        idpsessionStoreRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	interactionContext := &interaction.Context{
		Request:                  request,
		Database:                 sqlExecutor,
		Clock:                    clockClock,
		Config:                   appConfig,
		TrustProxy:               trustProxy,
		Identities:               identityFacade,
		Authenticators:           authenticatorFacade,
		AnonymousIdentities:      anonymousProvider,
		BiometricIdentities:      biometricProvider,
		OOBAuthenticators:        oobProvider,
		OOBCodeSender:            codeSender,
		OAuthProviderFactory:     oAuthProviderFactory,
		MFA:                      mfaService,
		ForgotPassword:           forgotpasswordProvider,
		ResetPassword:            forgotpasswordProvider,
		LoginIDNormalizerFactory: normalizerFactory,
		Verification:             verificationService,
		VerificationCodeSender:   verificationCodeSender,
		RateLimiter:              limiter,
		Nonces:                   nonceService,
		Search:                   elasticsearchService,
		Challenges:               challengeProvider,
		Users:                    userProvider,
		Events:                   eventService,
		CookieFactory:            cookieFactory,
		Sessions:                 idpsessionProvider,
		SessionManager:           idpsessionManager,
		SessionCookie:            cookieDef2,
		MFADeviceTokenCookie:     cookieDef,
	}
	interactionStoreRedis := &interaction.StoreRedis{
		Redis: redisHandle,
		AppID: appID,
	}
	interactionService := &interaction.Service{
		Logger:  logger,
		Context: interactionContext,
		Store:   interactionStoreRedis,
	}
	webappService2 := &webapp.Service2{
		Logger:               serviceLogger,
		Request:              request,
		Sessions:             sessionStoreRedis,
		SessionCookie:        sessionCookieDef,
		SignedUpCookie:       signedUpCookieDef,
		MFADeviceTokenCookie: cookieDef,
		ErrorCookie:          errorCookie,
		CookieFactory:        cookieFactory,
		Graph:                interactionService,
	}
	uiConfig := appConfig.UI
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	publisher := webapp2.NewPublisher(appID, redisHandle)
	controllerDeps := webapp2.ControllerDeps{
		Database:      handle,
		RedisHandle:   redisHandle,
		AppID:         appID,
		Page:          webappService2,
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
		Publisher:     publisher,
		Clock:         clockClock,
		UIConfig:      uiConfig,
		TrustProxy:    trustProxy,
	}
	controllerFactory := webapp2.ControllerFactory{
		LoggerFactory:  factory,
		ControllerDeps: controllerDeps,
	}
	errorHandler := &webapp2.ErrorHandler{
		ControllerFactory: controllerFactory,
		BaseViewModel:     baseViewModeler,
		Renderer:          responseRenderer,
	}
	return errorHandler
}

func newWebAppWebsocketHandler(p *deps.RequestProvider) http.Handler {
	appProvider := p.AppProvider
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	factory := appProvider.LoggerFactory
	handle := appProvider.Redis
	publisher := webapp2.NewPublisher(appID, handle)
	websocketHandler := &webapp2.WebsocketHandler{
		AppID:         appID,
		LoggerFactory: factory,
		RedisHandle:   handle,
		Publisher:     publisher,
	}
	return websocketHandler
}

// Injectors from wire_middleware.go:

func newSentryMiddleware(p *deps.RootProvider) httproute.Middleware {
	hub := p.SentryHub
	environmentConfig := p.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	sentryMiddleware := &middleware.SentryMiddleware{
		SentryHub:  hub,
		TrustProxy: trustProxy,
	}
	return sentryMiddleware
}

func newBodyLimitMiddleware(p *deps.RootProvider) httproute.Middleware {
	bodyLimitMiddleware := &middleware.BodyLimitMiddleware{}
	return bodyLimitMiddleware
}

func newPanicEndMiddleware(p *deps.RootProvider) httproute.Middleware {
	panicEndMiddleware := &middleware.PanicEndMiddleware{}
	return panicEndMiddleware
}

func newPanicWriteEmptyResponseMiddleware(p *deps.RequestProvider) httproute.Middleware {
	panicWriteEmptyResponseMiddleware := &middleware.PanicWriteEmptyResponseMiddleware{}
	return panicWriteEmptyResponseMiddleware
}

func newPanicLogMiddleware(p *deps.RequestProvider) httproute.Middleware {
	appProvider := p.AppProvider
	factory := appProvider.LoggerFactory
	panicLogMiddlewareLogger := middleware.NewPanicLogMiddlewareLogger(factory)
	panicLogMiddleware := &middleware.PanicLogMiddleware{
		Logger: panicLogMiddlewareLogger,
	}
	return panicLogMiddleware
}

func newPanicAPIMiddleware(p *deps.RequestProvider) httproute.Middleware {
	panicWriteAPIResponseMiddleware := &middleware.PanicWriteAPIResponseMiddleware{}
	return panicWriteAPIResponseMiddleware
}

func newPanicWebAppMiddleware(p *deps.RequestProvider) httproute.Middleware {
	appProvider := p.AppProvider
	config := appProvider.Config
	appConfig := config.AppConfig
	oAuthConfig := appConfig.OAuth
	uiConfig := appConfig.UI
	request := p.Request
	context := deps.ProvideRequestContext(request)
	httpConfig := appConfig.HTTP
	localizationConfig := appConfig.Localization
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	manager := appProvider.Resources
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	forgotPasswordConfig := appConfig.ForgotPassword
	authenticationConfig := appConfig.Authentication
	errorCookieDef := webapp.NewErrorCookieDef(httpConfig)
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	errorCookie := &webapp.ErrorCookie{
		Cookie:        errorCookieDef,
		CookieFactory: cookieFactory,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	resolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: resolver,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	clockClock := _wireSystemClockValue
	flashMessage := &httputil.FlashMessage{
		CookieFactory: cookieFactory,
	}
	baseViewModeler := &viewmodels.BaseViewModeler{
		OAuth:          oAuthConfig,
		AuthUI:         uiConfig,
		StaticAssets:   staticAssetResolver,
		ForgotPassword: forgotPasswordConfig,
		Authentication: authenticationConfig,
		ErrorCookie:    errorCookie,
		Translations:   translationService,
		Clock:          clockClock,
		FlashMessage:   flashMessage,
	}
	factory := appProvider.LoggerFactory
	responseRendererLogger := webapp2.NewResponseRendererLogger(factory)
	responseRenderer := &webapp2.ResponseRenderer{
		TemplateEngine: engine,
		Logger:         responseRendererLogger,
	}
	panicMiddleware := &webapp2.PanicMiddleware{
		BaseViewModel: baseViewModeler,
		Renderer:      responseRenderer,
	}
	return panicMiddleware
}

func newPublicOriginMiddleware(p *deps.RequestProvider) httproute.Middleware {
	appProvider := p.AppProvider
	config := appProvider.Config
	appConfig := config.AppConfig
	httpConfig := appConfig.HTTP
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	publicOriginMiddleware := &webapp.PublicOriginMiddleware{
		Config:     httpConfig,
		TrustProxy: trustProxy,
	}
	return publicOriginMiddleware
}

func newCORSMiddleware(p *deps.RequestProvider) httproute.Middleware {
	appProvider := p.AppProvider
	config := appProvider.Config
	appConfig := config.AppConfig
	httpConfig := appConfig.HTTP
	corsMiddleware := &middleware.CORSMiddleware{
		Config: httpConfig,
	}
	return corsMiddleware
}

func newSecHeadersMiddleware(p *deps.RequestProvider) httproute.Middleware {
	appProvider := p.AppProvider
	config := appProvider.Config
	appConfig := config.AppConfig
	httpConfig := appConfig.HTTP
	secHeadersMiddleware := provideSecHeadersMiddleware(httpConfig)
	return secHeadersMiddleware
}

func newCSRFMiddleware(p *deps.RequestProvider) httproute.Middleware {
	appProvider := p.AppProvider
	config := appProvider.Config
	secretConfig := config.SecretConfig
	csrfKeyMaterials := deps.ProvideCSRFKeyMaterials(secretConfig)
	appConfig := config.AppConfig
	httpConfig := appConfig.HTTP
	csrfCookieDef := webapp.NewCSRFCookieDef(httpConfig)
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	csrfMiddleware := &webapp.CSRFMiddleware{
		Secret:     csrfKeyMaterials,
		CookieDef:  csrfCookieDef,
		TrustProxy: trustProxy,
	}
	return csrfMiddleware
}

func newAuthEntryPointMiddleware(p *deps.RequestProvider) httproute.Middleware {
	appProvider := p.AppProvider
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	authEntryPointMiddleware := &webapp.AuthEntryPointMiddleware{
		TrustProxy: trustProxy,
	}
	return authEntryPointMiddleware
}

func newSessionMiddleware(p *deps.RequestProvider) httproute.Middleware {
	appProvider := p.AppProvider
	config := appProvider.Config
	appConfig := config.AppConfig
	httpConfig := appConfig.HTTP
	sessionConfig := appConfig.Session
	cookieDef := session.NewSessionCookieDef(httpConfig, sessionConfig)
	request := p.Request
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	handle := appProvider.Redis
	appID := appConfig.ID
	clockClock := _wireSystemClockValue
	factory := appProvider.LoggerFactory
	storeRedisLogger := idpsession.NewStoreRedisLogger(factory)
	storeRedis := &idpsession.StoreRedis{
		Redis:  handle,
		AppID:  appID,
		Clock:  clockClock,
		Logger: storeRedisLogger,
	}
	eventStoreRedis := &access.EventStoreRedis{
		Redis: handle,
		AppID: appID,
	}
	eventProvider := &access.EventProvider{
		Store: eventStoreRedis,
	}
	idpsessionRand := _wireRandValue
	provider := &idpsession.Provider{
		Request:      request,
		Store:        storeRedis,
		AccessEvents: eventProvider,
		TrustProxy:   trustProxy,
		Config:       sessionConfig,
		Clock:        clockClock,
		Random:       idpsessionRand,
	}
	resolver := &idpsession.Resolver{
		Cookie:     cookieDef,
		Provider:   provider,
		TrustProxy: trustProxy,
		Clock:      clockClock,
	}
	oAuthConfig := appConfig.OAuth
	secretConfig := config.SecretConfig
	databaseCredentials := deps.ProvideDatabaseCredentials(secretConfig)
	sqlBuilder := appdb.NewSQLBuilder(databaseCredentials, appID)
	context := deps.ProvideRequestContext(request)
	appdbHandle := appProvider.AppDatabase
	sqlExecutor := appdb.NewSQLExecutor(context, appdbHandle)
	authorizationStore := &pq.AuthorizationStore{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	logger := redis.NewLogger(factory)
	store := &redis.Store{
		Redis:       handle,
		AppID:       appID,
		Logger:      logger,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
		Clock:       clockClock,
	}
	oAuthKeyMaterials := deps.ProvideOAuthKeyMaterials(secretConfig)
	mainOriginProvider := &MainOriginProvider{
		Request:    request,
		TrustProxy: trustProxy,
	}
	endpointsProvider := &EndpointsProvider{
		OriginProvider: mainOriginProvider,
	}
	userStore := &user.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticationConfig := appConfig.Authentication
	identityConfig := appConfig.Identity
	serviceStore := &service.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginidStore := &loginid.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	loginIDConfig := identityConfig.LoginID
	manager := appProvider.Resources
	typeCheckerFactory := &loginid.TypeCheckerFactory{
		Config:    loginIDConfig,
		Resources: manager,
	}
	checker := &loginid.Checker{
		Config:             loginIDConfig,
		TypeCheckerFactory: typeCheckerFactory,
	}
	normalizerFactory := &loginid.NormalizerFactory{
		Config: loginIDConfig,
	}
	loginidProvider := &loginid.Provider{
		Store:             loginidStore,
		Config:            loginIDConfig,
		Checker:           checker,
		NormalizerFactory: normalizerFactory,
		Clock:             clockClock,
	}
	oauthStore := &oauth3.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oauthProvider := &oauth3.Provider{
		Store: oauthStore,
		Clock: clockClock,
	}
	anonymousStore := &anonymous.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	anonymousProvider := &anonymous.Provider{
		Store: anonymousStore,
		Clock: clockClock,
	}
	biometricStore := &biometric.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	biometricProvider := &biometric.Provider{
		Store: biometricStore,
		Clock: clockClock,
	}
	serviceService := &service.Service{
		Authentication: authenticationConfig,
		Identity:       identityConfig,
		Store:          serviceStore,
		LoginID:        loginidProvider,
		OAuth:          oauthProvider,
		Anonymous:      anonymousProvider,
		Biometric:      biometricProvider,
	}
	store2 := &service2.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordStore := &password.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorConfig := appConfig.Authenticator
	authenticatorPasswordConfig := authenticatorConfig.Password
	passwordLogger := password.NewLogger(factory)
	historyStore := &password.HistoryStore{
		Clock:       clockClock,
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	passwordChecker := password.ProvideChecker(authenticatorPasswordConfig, historyStore)
	housekeeperLogger := password.NewHousekeeperLogger(factory)
	housekeeper := &password.Housekeeper{
		Store:  historyStore,
		Logger: housekeeperLogger,
		Config: authenticatorPasswordConfig,
	}
	passwordProvider := &password.Provider{
		Store:           passwordStore,
		Config:          authenticatorPasswordConfig,
		Clock:           clockClock,
		Logger:          passwordLogger,
		PasswordHistory: historyStore,
		PasswordChecker: passwordChecker,
		Housekeeper:     housekeeper,
	}
	totpStore := &totp.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	authenticatorTOTPConfig := authenticatorConfig.TOTP
	totpProvider := &totp.Provider{
		Store:  totpStore,
		Config: authenticatorTOTPConfig,
		Clock:  clockClock,
	}
	authenticatorOOBConfig := authenticatorConfig.OOB
	oobStore := &oob.Store{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	oobStoreRedis := &oob.StoreRedis{
		Redis: handle,
		AppID: appID,
		Clock: clockClock,
	}
	oobLogger := oob.NewLogger(factory)
	oobProvider := &oob.Provider{
		Config:    authenticatorOOBConfig,
		Store:     oobStore,
		CodeStore: oobStoreRedis,
		Clock:     clockClock,
		Logger:    oobLogger,
	}
	ratelimitLogger := ratelimit.NewLogger(factory)
	storageRedis := &ratelimit.StorageRedis{
		AppID: appID,
		Redis: handle,
	}
	limiter := &ratelimit.Limiter{
		Logger:  ratelimitLogger,
		Storage: storageRedis,
		Clock:   clockClock,
	}
	service3 := &service2.Service{
		Store:       store2,
		Password:    passwordProvider,
		TOTP:        totpProvider,
		OOBOTP:      oobProvider,
		RateLimiter: limiter,
	}
	verificationLogger := verification.NewLogger(factory)
	verificationConfig := appConfig.Verification
	verificationStoreRedis := &verification.StoreRedis{
		Redis: handle,
		AppID: appID,
		Clock: clockClock,
	}
	storePQ := &verification.StorePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	verificationService := &verification.Service{
		Request:     request,
		Logger:      verificationLogger,
		Config:      verificationConfig,
		TrustProxy:  trustProxy,
		Clock:       clockClock,
		CodeStore:   verificationStoreRedis,
		ClaimStore:  storePQ,
		RateLimiter: limiter,
	}
	storeDeviceTokenRedis := &mfa.StoreDeviceTokenRedis{
		Redis: handle,
		AppID: appID,
		Clock: clockClock,
	}
	storeRecoveryCodePQ := &mfa.StoreRecoveryCodePQ{
		SQLBuilder:  sqlBuilder,
		SQLExecutor: sqlExecutor,
	}
	mfaService := &mfa.Service{
		DeviceTokens:  storeDeviceTokenRedis,
		RecoveryCodes: storeRecoveryCodePQ,
		Clock:         clockClock,
		Config:        authenticationConfig,
		RateLimiter:   limiter,
	}
	defaultLanguageTag := deps.ProvideDefaultLanguageTag(config)
	supportedLanguageTags := deps.ProvideSupportedLanguageTags(config)
	templateResolver := &template.Resolver{
		Resources:             manager,
		DefaultLanguageTag:    defaultLanguageTag,
		SupportedLanguageTags: supportedLanguageTags,
	}
	engine := &template.Engine{
		Resolver: templateResolver,
	}
	localizationConfig := appConfig.Localization
	staticAssetURLPrefix := environmentConfig.StaticAssetURLPrefix
	staticAssetResolver := &web.StaticAssetResolver{
		Context:            context,
		Config:             httpConfig,
		Localization:       localizationConfig,
		StaticAssetsPrefix: staticAssetURLPrefix,
		Resources:          manager,
	}
	translationService := &translation.Service{
		Context:           context,
		EnvironmentConfig: environmentConfig,
		TemplateEngine:    engine,
		StaticAssets:      staticAssetResolver,
	}
	welcomeMessageConfig := appConfig.WelcomeMessage
	queue := appProvider.TaskQueue
	welcomemessageProvider := &welcomemessage.Provider{
		Translation:          translationService,
		RateLimiter:          limiter,
		WelcomeMessageConfig: welcomeMessageConfig,
		TaskQueue:            queue,
	}
	rawCommands := &user.RawCommands{
		Store:                  userStore,
		Clock:                  clockClock,
		WelcomeMessageProvider: welcomemessageProvider,
	}
	idpsessionManager := &idpsession.Manager{
		Store:         storeRedis,
		Clock:         clockClock,
		Config:        sessionConfig,
		CookieFactory: cookieFactory,
		CookieDef:     cookieDef,
	}
	sessionManager := &oauth2.SessionManager{
		Store:  store,
		Clock:  clockClock,
		Config: oAuthConfig,
	}
	coordinator := &facade.Coordinator{
		Identities:      serviceService,
		Authenticators:  service3,
		Verification:    verificationService,
		MFA:             mfaService,
		Users:           rawCommands,
		PasswordHistory: historyStore,
		OAuth:           authorizationStore,
		IDPSessions:     idpsessionManager,
		OAuthSessions:   sessionManager,
		IdentityConfig:  identityConfig,
	}
	identityFacade := facade.IdentityFacade{
		Coordinator: coordinator,
	}
	queries := &user.Queries{
		Store:        userStore,
		Identities:   identityFacade,
		Verification: verificationService,
	}
	idTokenIssuer := &oidc.IDTokenIssuer{
		IDPSessions:   provider,
		OfflineGrants: store,
		Secrets:       oAuthKeyMaterials,
		BaseURL:       endpointsProvider,
		Users:         queries,
		Clock:         clockClock,
	}
	accessTokenEncoding := &oauth2.AccessTokenEncoding{
		Secrets:    oAuthKeyMaterials,
		Clock:      clockClock,
		UserClaims: idTokenIssuer,
		BaseURL:    endpointsProvider,
	}
	oauthResolver := &oauth2.Resolver{
		OAuthConfig:        oAuthConfig,
		TrustProxy:         trustProxy,
		Authorizations:     authorizationStore,
		AccessGrants:       store,
		OfflineGrants:      store,
		AppSessions:        store,
		AccessTokenDecoder: accessTokenEncoding,
		Sessions:           provider,
		SessionCookie:      cookieDef,
		Clock:              clockClock,
	}
	sessionMiddleware := &session.Middleware{
		SessionCookie:              cookieDef,
		CookieFactory:              cookieFactory,
		IDPSessionResolver:         resolver,
		AccessTokenSessionResolver: oauthResolver,
		AccessEvents:               eventProvider,
		Users:                      queries,
		Database:                   appdbHandle,
	}
	return sessionMiddleware
}

func newWebAppSessionMiddleware(p *deps.RequestProvider) httproute.Middleware {
	appProvider := p.AppProvider
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	handle := appProvider.Redis
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: handle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	request := p.Request
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	sessionMiddleware := &webapp.SessionMiddleware{
		States:        sessionStoreRedis,
		Cookie:        sessionCookieDef,
		CookieFactory: cookieFactory,
	}
	return sessionMiddleware
}

func newWebAppUILocalesMiddleware(p *deps.RequestProvider) httproute.Middleware {
	request := p.Request
	appProvider := p.AppProvider
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	uiLocalesMiddleware := &webapp.UILocalesMiddleware{
		CookieFactory: cookieFactory,
	}
	return uiLocalesMiddleware
}

func newWebAppClientIDMiddleware(p *deps.RequestProvider) httproute.Middleware {
	appProvider := p.AppProvider
	config := appProvider.Config
	appConfig := config.AppConfig
	appID := appConfig.ID
	handle := appProvider.Redis
	sessionStoreRedis := &webapp.SessionStoreRedis{
		AppID: appID,
		Redis: handle,
	}
	httpConfig := appConfig.HTTP
	sessionCookieDef := webapp.NewSessionCookieDef(httpConfig)
	clientIDCookieDef := webapp.NewClientIDCookieDef(httpConfig)
	request := p.Request
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	clientIDMiddleware := &webapp.ClientIDMiddleware{
		States:            sessionStoreRedis,
		SessionCookieDef:  sessionCookieDef,
		ClientIDCookieDef: clientIDCookieDef,
		CookieFactory:     cookieFactory,
	}
	return clientIDMiddleware
}

func newWebAppWeChatRedirectURIMiddleware(p *deps.RequestProvider) httproute.Middleware {
	request := p.Request
	appProvider := p.AppProvider
	rootProvider := appProvider.RootProvider
	environmentConfig := rootProvider.EnvironmentConfig
	trustProxy := environmentConfig.TrustProxy
	cookieFactory := deps.NewCookieFactory(request, trustProxy)
	weChatRedirectURIMiddleware := &webapp.WeChatRedirectURIMiddleware{
		CookieFactory: cookieFactory,
	}
	return weChatRedirectURIMiddleware
}

// wire_middleware.go:

func provideSecHeadersMiddleware(http2 *config.HTTPConfig) *web.SecHeadersMiddleware {
	return &web.SecHeadersMiddleware{CSPDirectives: http2.CSPDirectives}
}
